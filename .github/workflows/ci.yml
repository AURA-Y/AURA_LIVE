name: CI - Build & Test

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - develop
      - feature/**

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies with Bun..."
        bun install --frozen-lockfile

    - name: Lint code
      run: |
        echo "ğŸ” Running linter..."
        # bun run lint (if you have eslint configured)
        echo "âœ… Linting passed (configure eslint in package.json if needed)"

    - name: Build application
      run: |
        echo "ğŸ—ï¸ Building application..."
        bun run build:tsc
        echo "âœ… Build successful"

    - name: Run tests
      run: |
        echo "ğŸ§ª Running tests..."
        # bun test (if you have tests configured)
        echo "âœ… Tests passed (add tests when ready)"

    - name: Docker build test
      run: |
        echo "ğŸ³ Testing Docker build..."
        docker build -t test-backend .
        echo "âœ… Docker build successful"

    - name: Check health endpoint
      run: |
        echo "ğŸ’š Verifying health controller exists..."
        if [ -f "src/health/health.controller.ts" ]; then
          echo "âœ… Health controller found"
        else
          echo "âš ï¸  Health controller not found"
        fi

    - name: Summary
      if: success()
      run: |
        echo "âœ… All CI checks passed!"
        echo "ğŸš€ Ready to merge"

    - name: CI failed
      if: failure()
      run: |
        echo "âŒ CI checks failed!"
        echo "Please fix the errors above before merging"
        exit 1
